<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>These Words Are A Movie</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<!-- QR Code library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  :root {
    --pink-deep: #c2185b;
    --pink-hot: #e91e8c;
    --pink-mid: #f06292;
    --pink-light: #fce4ec;
    --pink-pale: #fff0f5;
    --cream: #fff8f0;
    --dark: #1a0a12;
    --text-main: #3d0020;
    --text-muted: #9e6b7e;
    --gold: #ffd54f;
    --gold-dark: #f9a825;
    --radius: 16px;
    --shadow: 0 8px 32px rgba(194,24,91,0.18);
    --shadow-lg: 0 16px 64px rgba(194,24,91,0.25);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--pink-pale);
    color: var(--text-main);
    min-height: 100vh;
    overflow-x: hidden;
    background-image:
      radial-gradient(circle at 10% 20%, rgba(233,30,140,0.07) 0%, transparent 50%),
      radial-gradient(circle at 90% 80%, rgba(240,98,146,0.09) 0%, transparent 50%);
  }

  /* ‚îÄ‚îÄ FIREBASE BANNER ‚îÄ‚îÄ */
  #fb-banner {
    position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
    padding: 11px 20px;
    display: flex; align-items: center; justify-content: space-between;
    font-family: 'Space Mono', monospace; font-size: 12px;
    transition: transform 0.5s ease, opacity 0.5s ease;
  }
  #fb-banner.connecting { background: linear-gradient(90deg,#fff3e0,#ffe0b2); color:#e65100; border-bottom:2px solid #ffb74d; }
  #fb-banner.connected  { background: linear-gradient(90deg,#e8f5e9,#c8e6c9); color:#1b5e20; border-bottom:2px solid #81c784; }
  #fb-banner.error      { background: linear-gradient(90deg,#fce4ec,#f8bbd0); color:#880e4f; border-bottom:2px solid #f48fb1; }
  #fb-banner.hidden     { transform: translateY(-100%); opacity:0; pointer-events:none; }
  #fb-banner .fb-status { display:flex; align-items:center; gap:8px; }
  #fb-banner .fb-dot    { width:8px; height:8px; border-radius:50%; }
  .connecting .fb-dot   { background:#ff9800; animation: pulse-dot 1.5s infinite; }
  .connected .fb-dot    { background:#4caf50; }
  .error .fb-dot        { background:#e91e63; }
  @keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(.7)} }
  #fb-banner .dismiss-btn { background:none; border:none; cursor:pointer; font-size:16px; color:inherit; opacity:.6; }
  #fb-banner .dismiss-btn:hover { opacity:1; }

  /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
  .page { display:none; padding:24px; max-width:860px; margin:0 auto; padding-top:72px; }
  .page.active { display:block; }

  /* ‚îÄ‚îÄ TITLE ‚îÄ‚îÄ */
  .game-title {
    font-family: 'Playfair Display', serif; font-weight:900;
    font-size: clamp(2.2rem,7vw,4.5rem);
    background: linear-gradient(135deg,var(--pink-deep) 0%,var(--pink-hot) 55%,var(--pink-mid) 100%);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    line-height:1.05; letter-spacing:-1.5px; text-align:center;
  }
  .game-subtitle { font-size:15px; color:var(--text-muted); text-align:center; margin-top:8px; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card { background:white; border-radius:var(--radius); padding:28px; box-shadow:var(--shadow); border:1.5px solid rgba(233,30,140,0.1); margin-bottom:20px; }
  .card-title { font-family:'Playfair Display',serif; font-size:1.35rem; color:var(--pink-deep); margin-bottom:16px; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 28px; border-radius:50px; border:none; font-family:'DM Sans',sans-serif; font-size:15px; font-weight:600; cursor:pointer; transition:all .2s; text-decoration:none; white-space:nowrap; }
  .btn-primary { background:linear-gradient(135deg,var(--pink-hot),var(--pink-deep)); color:white; box-shadow:0 4px 20px rgba(233,30,140,.35); }
  .btn-primary:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(233,30,140,.45); }
  .btn-secondary { background:white; color:var(--pink-deep); border:2px solid var(--pink-mid); }
  .btn-secondary:hover { background:var(--pink-light); transform:translateY(-2px); }
  .btn-danger { background:white; color:#c62828; border:2px solid #ef9a9a; }
  .btn-danger:hover { background:#ffebee; }
  .btn-end { background:linear-gradient(135deg,#b71c1c,#c62828); color:white; box-shadow:0 4px 20px rgba(183,28,28,.3); }
  .btn-end:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(183,28,28,.4); }
  .btn-sm { padding:8px 18px; font-size:13px; }
  .btn:disabled { opacity:.5; cursor:not-allowed; transform:none !important; }

  /* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
  .input-group { margin-bottom:16px; }
  .input-group label { display:block; font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:.8px; margin-bottom:6px; }
  input[type="text"],input[type="number"],select,textarea { width:100%; padding:12px 16px; border:2px solid rgba(233,30,140,.15); border-radius:10px; font-family:'DM Sans',sans-serif; font-size:15px; color:var(--text-main); background:white; transition:border-color .2s; outline:none; }
  input:focus,select:focus,textarea:focus { border-color:var(--pink-hot); box-shadow:0 0 0 3px rgba(233,30,140,.1); }

  /* ‚îÄ‚îÄ ROOM CODE ‚îÄ‚îÄ */
  .room-code-display { font-family:'Space Mono',monospace; font-size:3rem; font-weight:700; color:var(--pink-deep); letter-spacing:12px; text-align:center; padding:20px; background:var(--pink-light); border-radius:var(--radius); margin:16px 0; }

  /* ‚îÄ‚îÄ QR ‚îÄ‚îÄ */
  #qr-container { display:flex; flex-direction:column; align-items:center; gap:12px; padding:20px; background:white; border-radius:var(--radius); border:2px solid rgba(233,30,140,.12); margin-top:16px; }
  #qr-canvas { border-radius:12px; overflow:hidden; }
  .qr-caption { font-size:12px; color:var(--text-muted); text-align:center; font-weight:500; }
  .qr-url { font-family:'Space Mono',monospace; font-size:10px; color:var(--pink-deep); background:var(--pink-light); padding:4px 10px; border-radius:6px; word-break:break-all; text-align:center; max-width:280px; }

  /* ‚îÄ‚îÄ PLAYERS ‚îÄ‚îÄ */
  .player-list { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
  .player-chip { display:flex; align-items:center; gap:6px; padding:6px 14px; background:var(--pink-light); border-radius:50px; font-size:14px; font-weight:500; color:var(--pink-deep); border:2px solid transparent; transition:all .3s; }
  .player-chip.host-chip { border-color:var(--pink-hot); background:white; }
  .player-chip.submitted { background:#e8f5e9; color:#2e7d32; border-color:#a5d6a7; }
  .player-chip .avatar { width:24px; height:24px; border-radius:50%; background:linear-gradient(135deg,var(--pink-hot),var(--pink-deep)); display:flex; align-items:center; justify-content:center; font-size:11px; color:white; font-weight:700; flex-shrink:0; }

  /* ‚îÄ‚îÄ WORD CARDS ‚îÄ‚îÄ */
  .word-cards { display:flex; gap:14px; flex-wrap:wrap; justify-content:center; margin:24px 0; }
  .word-card { position:relative; width:155px; height:155px; perspective:600px; }
  .word-card-inner { position:relative; width:100%; height:100%; transform-style:preserve-3d; transition:transform .7s cubic-bezier(.4,0,.2,1); }
  .word-card.flipped .word-card-inner { transform:rotateY(180deg); }
  .word-card-front,.word-card-back { position:absolute; inset:0; border-radius:var(--radius); backface-visibility:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:16px; text-align:center; }
  .word-card-front { background:linear-gradient(145deg,var(--pink-hot),var(--pink-deep)); box-shadow:var(--shadow); }
  .word-card-front .word-text { font-family:'Playfair Display',serif; font-size:1.4rem; font-weight:700; color:white; text-shadow:0 2px 8px rgba(0,0,0,.2); }
  .word-card-back { background:white; border:2px solid var(--pink-mid); transform:rotateY(180deg); box-shadow:var(--shadow); }
  .word-card-back .conn-word { font-family:'Playfair Display',serif; font-size:1rem; font-weight:700; color:var(--pink-deep); margin-bottom:6px; }
  .word-card-back .conn-explain { font-size:11px; color:var(--text-muted); line-height:1.4; }

  /* ‚îÄ‚îÄ HOST ANSWER CARD (always revealed for host) ‚îÄ‚îÄ */
  .host-answer-banner { background:linear-gradient(135deg,var(--pink-deep),var(--pink-hot)); border-radius:var(--radius); padding:20px 28px; color:white; margin-bottom:20px; box-shadow:var(--shadow-lg); }
  .host-answer-banner .label { font-size:11px; text-transform:uppercase; letter-spacing:2px; opacity:.8; }
  .host-answer-banner .movie-name { font-family:'Playfair Display',serif; font-size:2rem; font-weight:900; margin-top:4px; }
  .host-answer-banner .meta { font-size:13px; opacity:.8; margin-top:4px; }
  .host-word-grid { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
  .host-word-pill { background:rgba(255,255,255,.15); border-radius:10px; padding:8px 14px; font-size:13px; color:white; border:1px solid rgba(255,255,255,.3); }
  .host-word-pill strong { display:block; font-size:15px; font-family:'Playfair Display',serif; }

  /* ‚îÄ‚îÄ HOST SPECTATOR VIEW ‚îÄ‚îÄ */
  .host-badge { display:inline-flex; align-items:center; gap:6px; background:linear-gradient(135deg,var(--pink-hot),var(--pink-deep)); color:white; border-radius:50px; padding:6px 16px; font-size:13px; font-weight:700; margin-bottom:16px; }

  /* ‚îÄ‚îÄ HINTS ‚îÄ‚îÄ */
  .hints-bar { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:12px 0; }
  .hint-btn { padding:8px 16px; border-radius:50px; border:2px solid var(--pink-mid); background:white; color:var(--pink-deep); font-size:13px; font-weight:600; cursor:pointer; transition:all .2s; font-family:'DM Sans',sans-serif; }
  .hint-btn:hover:not(:disabled) { background:var(--pink-light); border-color:var(--pink-hot); }
  .hint-btn.used { background:var(--pink-light); border-color:var(--pink-mid); color:var(--text-muted); cursor:default; }
  .hint-btn:disabled { opacity:.4; cursor:not-allowed; }
  .hint-reveal { background:linear-gradient(135deg,#fff3e0,#ffe0b2); border-radius:10px; padding:8px 16px; margin:4px; font-size:13px; color:#e65100; font-weight:600; display:inline-block; border:1px solid #ffb74d; }
  .hint-cost-note { font-size:11px; color:var(--text-muted); text-align:center; margin-top:6px; }

  /* ‚îÄ‚îÄ POINTS ‚îÄ‚îÄ */
  .points-preview { display:flex; gap:6px; justify-content:center; flex-wrap:wrap; margin-top:6px; }
  .points-badge { background:var(--pink-light); color:var(--pink-deep); border-radius:50px; padding:4px 12px; font-size:13px; font-weight:700; border:1.5px solid var(--pink-mid); font-family:'Space Mono',monospace; }
  .points-badge.active-pts { background:linear-gradient(135deg,var(--pink-hot),var(--pink-deep)); color:white; border-color:transparent; }

  /* ‚îÄ‚îÄ REVEAL ‚îÄ‚îÄ */
  .reveal-section { display:none; }
  .reveal-section.visible { display:block; }
  .movie-answer { text-align:center; padding:24px; background:linear-gradient(135deg,var(--pink-deep),var(--pink-hot)); border-radius:var(--radius); color:white; margin-bottom:20px; box-shadow:var(--shadow-lg); }
  .movie-answer .label { font-size:11px; text-transform:uppercase; letter-spacing:2px; opacity:.8; }
  .movie-answer .title { font-family:'Playfair Display',serif; font-size:2rem; font-weight:900; margin-top:4px; }

  /* ‚îÄ‚îÄ GUESSES LIST ‚îÄ‚îÄ */
  .guesses-list { list-style:none; }
  .guess-item { display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:10px; background:white; margin-bottom:8px; border:1.5px solid transparent; transition:all .3s; flex-wrap:wrap; }
  .guess-item.correct { border-color:#81c784; background:#f1f8e9; }
  .guess-item.wrong { border-color:#ef9a9a; background:#fff8f8; }
  .guess-player { font-weight:700; min-width:90px; }
  .guess-answer { flex:1; color:var(--text-muted); font-style:italic; }
  .correct-badge { background:#4caf50; color:white; border-radius:50px; padding:2px 10px; font-size:11px; font-weight:700; white-space:nowrap; }
  .guess-score { font-family:'Space Mono',monospace; font-weight:700; color:var(--pink-deep); white-space:nowrap; }

  /* ‚îÄ‚îÄ SCOREBOARD ‚îÄ‚îÄ */
  .scoreboard { list-style:none; }
  .score-row { display:flex; align-items:center; padding:12px 16px; border-radius:10px; margin-bottom:8px; background:var(--pink-pale); gap:12px; animation:pop-in .4s cubic-bezier(.34,1.56,.64,1) both; }
  .score-row:first-child { background:linear-gradient(135deg,#fff9c4,#fff176); border:2px solid var(--gold); }
  .score-rank { width:28px; height:28px; border-radius:50%; background:var(--pink-mid); color:white; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; flex-shrink:0; }
  .score-row:first-child .score-rank { background:var(--gold-dark); }
  .score-name { flex:1; font-weight:600; }
  .score-pts { font-family:'Space Mono',monospace; font-size:1.1rem; font-weight:700; color:var(--pink-deep); }
  .score-row:first-child .score-pts { color:var(--gold-dark); }

  /* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
  .admin-movie-card { background:var(--pink-pale); border-radius:var(--radius); padding:20px; margin-bottom:14px; border:2px solid rgba(233,30,140,.15); }
  .word-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end; }
  .tab-bar { display:flex; gap:4px; margin-bottom:24px; background:var(--pink-light); border-radius:50px; padding:4px; }
  .tab-btn { flex:1; padding:10px; border:none; border-radius:50px; background:none; font-family:'DM Sans',sans-serif; font-size:14px; font-weight:600; cursor:pointer; color:var(--text-muted); transition:all .2s; }
  .tab-btn.active { background:white; color:var(--pink-deep); box-shadow:0 2px 8px rgba(233,30,140,.15); }
  .add-word-btn { font-size:13px; padding:8px 14px; cursor:pointer; background:var(--pink-light); border:2px dashed var(--pink-mid); border-radius:8px; color:var(--pink-deep); font-weight:600; font-family:'DM Sans',sans-serif; transition:all .2s; width:100%; margin-top:8px; }
  .add-word-btn:hover { border-color:var(--pink-hot); }
  .add-word-btn:disabled { opacity:.4; cursor:not-allowed; }
  .remove-btn { background:none; border:none; cursor:pointer; color:#ef9a9a; font-size:18px; transition:color .2s; }
  .remove-btn:hover { color:#c62828; }
  .saved-movie-item { display:flex; align-items:flex-start; justify-content:space-between; padding:12px 16px; background:white; border-radius:10px; margin-bottom:8px; border:1.5px solid rgba(233,30,140,.1); gap:12px; }
  .saved-movie-title { font-weight:700; }
  .word-tag { background:var(--pink-light); color:var(--pink-deep); border-radius:50px; padding:2px 10px; font-size:12px; font-weight:600; border:1px solid var(--pink-mid); }

  /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
  .section-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:8px; }
  .divider { height:1px; background:linear-gradient(90deg,transparent,rgba(233,30,140,.2),transparent); margin:20px 0; }
  .status-bar { display:flex; align-items:center; gap:8px; padding:10px 16px; background:var(--pink-light); border-radius:50px; font-size:13px; color:var(--pink-deep); font-weight:500; justify-content:center; }
  .waiting-dots::after { content:''; animation:dots 1.5s infinite; }
  @keyframes dots { 0%{content:''} 33%{content:'.'} 66%{content:'..'} 100%{content:'...'} }
  .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--dark); color:white; padding:12px 24px; border-radius:50px; font-size:14px; font-weight:500; z-index:9998; transition:transform .4s cubic-bezier(.34,1.56,.64,1),opacity .4s; opacity:0; max-width:90vw; text-align:center; }
  .toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(26,10,18,.7); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
  .modal-overlay.open { display:flex; }
  .modal { background:white; border-radius:20px; padding:32px; max-width:440px; width:90%; box-shadow:var(--shadow-lg); text-align:center; }
  .modal h3 { font-family:'Playfair Display',serif; font-size:1.5rem; color:var(--pink-deep); margin-bottom:12px; }
  .modal .modal-actions { display:flex; gap:10px; justify-content:center; margin-top:20px; }
  @keyframes pop-in { 0%{transform:scale(.8);opacity:0} 100%{transform:scale(1);opacity:1} }
  .confetti-burst { font-size:3.5rem; text-align:center; animation:pop-in .6s cubic-bezier(.34,1.56,.64,1); }
  .winner-name { font-family:'Playfair Display',serif; font-size:2rem; color:var(--pink-deep); text-align:center; font-weight:900; }

  @media(max-width:600px) {
    .word-row { grid-template-columns:1fr; }
    .word-card { width:130px; height:130px; }
    .word-card-front .word-text { font-size:1.1rem; }
  }
</style>
</head>
<body>

<!-- FIREBASE BANNER -->
<div id="fb-banner" class="connecting">
  <div class="fb-status">
    <div class="fb-dot"></div>
    <span id="fb-status-text">Connecting to Firebase‚Ä¶</span>
  </div>
  <button class="dismiss-btn" onclick="dismissBanner()">‚úï</button>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HOME PAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-home" class="page active">
  <div style="margin-bottom:36px;padding-top:10px;">
    <div class="game-title">These Words<br>Are A Movie</div>
    <div class="game-subtitle">Guess the film from Alie's terrible clues üé¨</div>
  </div>

  <div class="card">
    <div class="card-title">Who are you?</div>
    <div class="input-group">
      <label>Your Name</label>
      <input type="text" id="player-name-input" placeholder="Enter your name‚Ä¶" maxlength="20">
    </div>
  </div>

  <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;">
    <button class="btn btn-primary" onclick="showCreateRoom()">üéÆ Create Room (Host)</button>
    <button class="btn btn-secondary" onclick="showJoinRoom()">üö™ Join Room</button>
  </div>

  <div style="text-align:center;margin-top:48px;">
    <button onclick="goToAdmin()" style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--text-muted);opacity:0.4;font-family:'Space Mono',monospace;letter-spacing:0.5px;padding:6px 10px;border-radius:6px;transition:opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='0.4'">admin</button>
  </div>

  <div id="create-room-section" class="card" style="display:none;margin-top:20px;">
    <div class="card-title">Create a Room</div>
    <p style="font-size:14px;color:var(--text-muted);margin-bottom:16px;">As host you'll see all the answers and control the game ‚Äî you won't be a player.</p>
    <button class="btn btn-primary" onclick="createRoom()">Create Room ‚ú®</button>
  </div>

  <div id="join-room-section" class="card" style="display:none;margin-top:20px;">
    <div class="card-title">Join a Room</div>
    <div class="input-group">
      <label>Room Code</label>
      <input type="text" id="join-code-input" placeholder="ABCD" maxlength="6"
        style="text-transform:uppercase;font-family:'Space Mono',monospace;font-size:1.6rem;letter-spacing:8px;text-align:center;">
    </div>
    <button class="btn btn-primary" onclick="joinRoom()">Join ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOBBY PAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-lobby" class="page">
  <div style="margin-bottom:28px;">
    <div class="game-title" style="font-size:clamp(1.8rem,5vw,3rem);">Lobby üé≠</div>
  </div>

  <div class="card">
    <div class="card-title">Room Code</div>
    <div class="room-code-display" id="lobby-room-code">----</div>
    <div id="qr-container">
      <div id="qr-canvas"></div>
      <div class="qr-caption">Scan to join instantly ‚Üí</div>
      <div class="qr-url" id="qr-url-display"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Players</div>
    <div style="font-size:13px;color:var(--text-muted);margin-bottom:8px;" id="lobby-host-name-display"></div>
    <div class="player-list" id="lobby-players"></div>
  </div>

  <div style="text-align:center;margin-top:8px;">
    <div id="lobby-host-controls" style="display:none;display:flex;flex-direction:column;align-items:center;gap:12px;">
      <button class="btn btn-primary" onclick="startGame()" id="start-game-btn">Start Game üöÄ</button>
    </div>
    <div id="lobby-waiting-msg" class="status-bar" style="display:none;">
      <span>Waiting for host to start<span class="waiting-dots"></span></span>
    </div>
    <button class="btn btn-danger btn-sm" style="margin-top:14px;" onclick="leaveRoom()">Leave Room</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     GAME PAGE ‚Äî PLAYER VIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-game" class="page">
  <!-- Round header -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
    <div>
      <div class="section-label">Round</div>
      <div style="font-family:'Space Mono',monospace;font-size:1.6rem;font-weight:700;color:var(--pink-deep);" id="round-display">1</div>
    </div>
    <div>
      <div class="section-label" style="text-align:right;">Your Score</div>
      <div style="font-family:'Space Mono',monospace;font-size:1.6rem;font-weight:700;color:var(--pink-deep);text-align:right;" id="my-score-display">0</div>
    </div>
  </div>

  <!-- Word cards -->
  <div class="word-cards" id="word-cards"></div>

  <!-- Hints card -->
  <div class="card" id="hints-card">
    <div class="card-title" style="font-size:1rem;margin-bottom:8px;">Need a hint?</div>
    <div class="hints-bar" id="hints-bar"></div>
    <div id="hints-revealed" style="display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-top:8px;"></div>
    <div class="hint-cost-note">Genre ‚àí2pts &nbsp;‚Ä¢&nbsp; Year ‚àí3pts &nbsp;‚Ä¢&nbsp; First Letter ‚àí1pt</div>
  </div>

  <!-- Points preview -->
  <div style="text-align:center;margin-bottom:16px;">
    <div class="section-label">Points available this round</div>
    <div class="points-preview" id="points-preview"></div>
  </div>

  <!-- Guess / waiting -->
  <div class="card">
    <div id="guess-form-section">
      <div class="card-title">What movie is it? üé¨</div>
      <div class="input-group">
        <input type="text" id="guess-input" placeholder="Type your guess‚Ä¶" autocomplete="off">
      </div>
      <button class="btn btn-primary" onclick="submitGuess()" id="submit-guess-btn">Submit Guess ‚úì</button>
    </div>
    <div id="guess-waiting-section" style="display:none;text-align:center;padding:16px;">
      <div style="font-size:2.5rem;">‚úÖ</div>
      <div style="font-size:1.1rem;font-weight:700;color:var(--pink-deep);margin-top:8px;">Guess submitted!</div>
      <div style="font-size:13px;color:var(--text-muted);margin-top:4px;">Waiting for others<span class="waiting-dots"></span></div>
      <div class="player-list" id="submitted-players-list" style="justify-content:center;margin-top:14px;"></div>
    </div>
  </div>

  <!-- Reveal (player) -->
  <div class="reveal-section card" id="reveal-section">
    <div class="movie-answer">
      <div class="label">The movie was‚Ä¶</div>
      <div class="title" id="movie-title-reveal">‚Äî</div>
    </div>
    <div class="section-label" style="margin-bottom:12px;">Round Results</div>
    <ul class="guesses-list" id="guesses-reveal-list"></ul>
    <div id="waiting-next-msg" class="status-bar" style="display:none;margin-top:16px;">
      <span>Waiting for host<span class="waiting-dots"></span></span>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HOST VIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-host" class="page">
  <!-- Header -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
    <div>
      <div class="section-label">Round</div>
      <div style="font-family:'Space Mono',monospace;font-size:1.6rem;font-weight:700;color:var(--pink-deep);" id="host-round-display">1</div>
    </div>
    <div class="host-badge">üé¨ Host View</div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-end btn-sm" onclick="endGame()">End Game üèÅ</button>
    </div>
  </div>

  <!-- Answer reveal for host ‚Äî always visible -->
  <div class="host-answer-banner" id="host-answer-banner">
    <div class="label">The Answer Is‚Ä¶</div>
    <div class="movie-name" id="host-movie-name">‚Äî</div>
    <div class="meta" id="host-movie-meta"></div>
    <div class="host-word-grid" id="host-word-grid"></div>
  </div>

  <!-- Submissions live view -->
  <div class="card">
    <div class="card-title" style="font-size:1rem;">Live Submissions</div>
    <div class="player-list" id="host-submitted-list"></div>
    <div class="status-bar" id="host-waiting-status" style="margin-top:16px;">
      Waiting for guesses<span class="waiting-dots"></span>
    </div>
  </div>

  <!-- Scoreboard live -->
  <div class="card">
    <div class="card-title" style="font-size:1rem;">Scoreboard</div>
    <ul class="scoreboard" id="host-live-scores"></ul>
  </div>

  <!-- Reveal section (host) -->
  <div class="reveal-section card" id="host-reveal-section">
    <div class="section-label" style="margin-bottom:12px;">Round Results</div>
    <ul class="guesses-list" id="host-guesses-list"></ul>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="nextRound()" id="host-next-btn">Next Round ‚Üí</button>
      <button class="btn btn-end" onclick="endGame()">End Game üèÅ</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCOREBOARD PAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-scoreboard" class="page">
  <div style="margin-bottom:28px;">
    <div class="game-title" style="font-size:clamp(1.8rem,5vw,3rem);">Final Scores üèÜ</div>
  </div>
  <div class="card">
    <div id="winner-display" style="margin-bottom:20px;"></div>
    <ul class="scoreboard" id="final-scoreboard"></ul>
  </div>
  <div style="text-align:center;margin-top:20px;">
    <button class="btn btn-primary" onclick="goHome()">Play Again üéÆ</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ADMIN PAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-admin" class="page">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px;flex-wrap:wrap;">
    <button class="btn btn-secondary btn-sm" onclick="goHome()">‚Üê Back</button>
    <div class="game-title" style="font-size:1.8rem;">Admin Panel üîß</div>
  </div>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchAdminTab('add')">Add Movie</button>
    <button class="tab-btn" onclick="switchAdminTab('list')">Movie Library</button>
  </div>

  <!-- Add tab -->
  <div id="admin-tab-add">
    <div class="card">
      <div class="card-title">Add a Movie</div>
      <div class="input-group">
        <label>Movie Title</label>
        <input type="text" id="admin-movie-title" placeholder="e.g. Guardians of the Galaxy Vol. 2">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="input-group" style="margin:0;">
          <label>Genre</label>
          <input type="text" id="admin-movie-genre" placeholder="e.g. Sci-Fi Comedy">
        </div>
        <div class="input-group" style="margin:0;">
          <label>Year</label>
          <input type="number" id="admin-movie-year" placeholder="e.g. 2017" min="1900" max="2099">
        </div>
      </div>
      <div style="height:16px;"></div>
      <div class="section-label">Clue Words (3‚Äì5 words)</div>
      <div id="admin-words-container"></div>
      <button class="add-word-btn" onclick="addWordRow()" id="add-word-btn">+ Add Clue Word</button>
      <div style="margin-top:24px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="saveMovie()">Save Movie üíæ</button>
        <button class="btn btn-secondary" onclick="clearMovieForm()">Clear Form</button>
      </div>
    </div>
  </div>

  <!-- Library tab -->
  <div id="admin-tab-list" style="display:none;">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div class="card-title" style="margin:0;">Saved Movies</div>
        <button class="btn btn-secondary btn-sm" onclick="loadMovieLibrary()">‚Üª Refresh</button>
      </div>
      <ul id="saved-movies-list" style="list-style:none;">
        <li style="color:var(--text-muted);font-size:14px;">Loading‚Ä¶</li>
      </ul>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div id="delete-modal" class="modal-overlay">
  <div class="modal">
    <h3>Delete this movie?</h3>
    <p style="color:var(--text-muted);">This can't be undone.</p>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- END GAME MODAL -->
<div id="end-modal" class="modal-overlay">
  <div class="modal">
    <h3>End the game?</h3>
    <p style="color:var(--text-muted);">This will show final scores to everyone.</p>
    <div class="modal-actions">
      <button class="btn btn-end" onclick="confirmEndGame()">Yes, End Game</button>
      <button class="btn btn-secondary" onclick="closeEndModal()">Keep Playing</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FIREBASE + GAME LOGIC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, push, update, onValue, off, remove }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyACjTgX3a7Cgl_7id62sMn0Xh2LER9x8Ig",
  authDomain: "thesewordsareamovie.firebaseapp.com",
  projectId: "thesewordsareamovie",
  storageBucket: "thesewordsareamovie.firebasestorage.app",
  messagingSenderId: "516153696624",
  appId: "1:516153696624:web:15feecb52bf80cf0b5afb5",
  measurementId: "G-DL2MQ6S957",
  databaseURL: "https://thesewordsareamovie-default-rtdb.firebaseio.com"
};

let app, db;
let currentRoom = null;
let playerId = null;
let playerName = '';
let isHost = false;
let roomListenerRef = null;
let wordRowCount = 0;
let deleteTargetId = null;
let myHintsUsed = [];
let myGuessSubmitted = false;
let qrInstance = null;
// Track which movie IDs have been used so we don't repeat
let usedMovieIds = [];

// ‚îÄ‚îÄ Firebase init ‚îÄ‚îÄ
try {
  app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  setBanner('connected', '‚úì Connected to Firebase');
  setTimeout(() => { if (!document.getElementById('fb-banner').classList.contains('error')) dismissBanner(); }, 3500);
} catch(e) {
  setBanner('error', '‚úó Firebase connection failed: ' + e.message);
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function setBanner(type, msg) {
  const b = document.getElementById('fb-banner');
  b.className = type;
  document.getElementById('fb-status-text').textContent = msg;
  b.classList.remove('hidden');
}
window.dismissBanner = () => document.getElementById('fb-banner').classList.add('hidden');

function showToast(msg, dur=2800) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
}

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  window.scrollTo(0,0);
}

function normalize(s) {
  return (s||'').toLowerCase().replace(/[^a-z0-9]/g,'').trim();
}
// Levenshtein distance
function levenshtein(a, b) {
  const m = a.length, n = b.length;
  const dp = Array.from({length:m+1},(_,i)=>Array.from({length:n+1},(_,j)=>i===0?j:j===0?i:0));
  for(let i=1;i<=m;i++) for(let j=1;j<=n;j++)
    dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]:1+Math.min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1]);
  return dp[m][n];
}
// Forgiving match: allows small typos
function isCloseEnough(guess, answer) {
  const g = normalize(guess), a = normalize(answer);
  if (g === a) return true;
  const maxDist = a.length >= 6 ? 2 : (a.length >= 3 ? 1 : 0);
  if (levenshtein(g, a) <= maxDist) return true;
  if (a.includes(g) && g.length >= 3) return true;
  if (g.includes(a) && a.length >= 3) return true;
  return false;
}
function getMaxPoints(hintsUsed) {
  let pts = 10;
  if (hintsUsed.includes('genre')) pts -= 2;
  if (hintsUsed.includes('year')) pts -= 3;
  if (hintsUsed.includes('firstletter')) pts -= 1;
  return Math.max(pts, 1);
}

// ‚îÄ‚îÄ QR Code ‚îÄ‚îÄ
function generateQR(code) {
  const container = document.getElementById('qr-canvas');
  container.innerHTML = '';
  const url = `${window.location.origin}${window.location.pathname}?room=${code}`;
  document.getElementById('qr-url-display').textContent = url;
  try {
    qrInstance = new QRCode(container, {
      text: url, width: 200, height: 200,
      colorDark: '#c2185b', colorLight: '#fff0f5',
      correctLevel: QRCode.CorrectLevel.M
    });
  } catch(e) { container.textContent = url; }
}

// ‚îÄ‚îÄ Auto-join from URL param ‚îÄ‚îÄ
function checkURLParams() {
  const params = new URLSearchParams(window.location.search);
  const room = params.get('room');
  if (room) {
    document.getElementById('join-code-input').value = room.toUpperCase();
    document.getElementById('join-room-section').style.display = 'block';
    document.getElementById('create-room-section').style.display = 'none';
    showToast('Room code pre-filled! Enter your name and join üëá');
  }
}

// ‚îÄ‚îÄ HOME ‚îÄ‚îÄ
window.goHome = () => {
  stopListener();
  currentRoom = null; isHost = false; myHintsUsed = []; myGuessSubmitted = false; usedMovieIds = [];
  showPage('home');
};

window.showCreateRoom = () => {
  if (!getPlayerName()) return;
  document.getElementById('create-room-section').style.display = 'block';
  document.getElementById('join-room-section').style.display = 'none';
};
window.showJoinRoom = () => {
  if (!getPlayerName()) return;
  document.getElementById('join-room-section').style.display = 'block';
  document.getElementById('create-room-section').style.display = 'none';
};

function getPlayerName() {
  const n = document.getElementById('player-name-input').value.trim();
  if (!n) { showToast('Please enter your name first!'); return null; }
  playerName = n;
  return n;
}

// ‚îÄ‚îÄ CREATE ROOM ‚îÄ‚îÄ
window.createRoom = async () => {
  if (!getPlayerName()) return;
  const code = Math.random().toString(36).substring(2,6).toUpperCase();
  playerId = 'host_' + Date.now();
  isHost = true;
  currentRoom = code;

  await set(ref(db, 'rooms/' + code), {
    code, status: 'lobby', currentRound: 0, host: playerId,
    hostName: playerName, usedMovies: {},
    players: {}  // host is NOT a player
  });

  showPage('lobby');
  document.getElementById('lobby-room-code').textContent = code;
  generateQR(code);
  document.getElementById('lobby-host-name-display').textContent = `Host: ${playerName} (you)`;
  document.getElementById('lobby-host-controls').style.display = 'flex';
  document.getElementById('lobby-waiting-msg').style.display = 'none';
  startListener(code);
};

// ‚îÄ‚îÄ JOIN ROOM ‚îÄ‚îÄ
window.joinRoom = async () => {
  if (!getPlayerName()) return;
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  if (!code) { showToast('Enter a room code!'); return; }

  const snap = await get(ref(db, 'rooms/' + code));
  if (!snap.exists()) { showToast('Room not found!'); return; }
  const room = snap.val();
  if (room.status !== 'lobby') { showToast('Game already started!'); return; }

  playerId = 'p_' + Date.now();
  isHost = false;
  currentRoom = code;

  await update(ref(db, 'rooms/' + code + '/players/' + playerId), { name: playerName, score: 0 });

  showPage('lobby');
  startListener(code);
};

// ‚îÄ‚îÄ LISTENER ‚îÄ‚îÄ
function stopListener() {
  if (roomListenerRef) { off(roomListenerRef); roomListenerRef = null; }
}
function startListener(code) {
  stopListener();
  roomListenerRef = ref(db, 'rooms/' + code);
  onValue(roomListenerRef, snap => {
    if (!snap.exists()) { showToast('Room was closed'); showPage('home'); return; }
    const room = snap.val();
    if (room.status === 'lobby') renderLobby(room);
    else if (room.status === 'playing') {
      if (isHost) renderHostGame(room);
      else renderPlayerGame(room);
    }
    else if (room.status === 'gameover') renderGameOver(room);
  });
}

// ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ
function renderLobby(room) {
  showPage('lobby');
  document.getElementById('lobby-room-code').textContent = room.code;
  if (!document.getElementById('qr-canvas').innerHTML) generateQR(room.code);

  document.getElementById('lobby-host-name-display').textContent =
    `Host: ${room.hostName}${isHost?' (you)':''}`;

  const el = document.getElementById('lobby-players');
  el.innerHTML = '';
  Object.entries(room.players||{}).forEach(([pid, p]) => {
    const chip = document.createElement('div');
    chip.className = 'player-chip' + (pid===playerId?' host-chip':'');
    chip.innerHTML = `<div class="avatar">${p.name[0].toUpperCase()}</div>${p.name}${pid===playerId?' (you)':''}`;
    el.appendChild(chip);
  });
  if (Object.keys(room.players||{}).length === 0) {
    el.innerHTML = '<span style="color:var(--text-muted);font-size:14px;">No players yet‚Ä¶ share the room code!</span>';
  }

  if (isHost) {
    document.getElementById('lobby-host-controls').style.display = 'flex';
    document.getElementById('lobby-waiting-msg').style.display = 'none';
  } else {
    document.getElementById('lobby-host-controls').style.display = 'none';
    document.getElementById('lobby-waiting-msg').style.display = 'flex';
  }
}

// ‚îÄ‚îÄ START GAME ‚îÄ‚îÄ
window.startGame = async () => {
  const snap = await get(ref(db, 'rooms/' + currentRoom));
  const room = snap.val();
  const players = Object.keys(room.players||{});
  if (players.length < 1) { showToast('Need at least 1 player!'); return; }

  // Pick first movie
  const movie = await pickNextMovie({});
  if (!movie) { showToast('No movies in library! Add some in Admin Panel.'); return; }

  const updates = {};
  updates[`rooms/${currentRoom}/status`] = 'playing';
  updates[`rooms/${currentRoom}/currentRound`] = 1;
  updates[`rooms/${currentRoom}/rounds/1`] = {
    movieId: movie.id, movie: movie.title, words: movie.words,
    genre: movie.genre||'', year: movie.year||'', status: 'guessing'
  };
  updates[`rooms/${currentRoom}/usedMovies/${movie.id}`] = true;
  await update(ref(db), updates);
};

async function pickNextMovie(usedMovies) {
  const snap = await get(ref(db, 'movies'));
  if (!snap.exists()) return null;
  const all = Object.entries(snap.val());
  const available = all.filter(([id]) => !usedMovies[id]);
  if (!available.length) return null;
  const [id, data] = available[Math.floor(Math.random() * available.length)];
  return { id, ...data };
}

// ‚îÄ‚îÄ PLAYER GAME ‚îÄ‚îÄ
function renderPlayerGame(room) {
  showPage('game');
  const cr = room.currentRound;
  const round = room.rounds?.[cr];
  if (!round) return;

  document.getElementById('round-display').textContent = `Round ${cr}`;
  document.getElementById('my-score-display').textContent = room.players?.[playerId]?.score || 0;

  if (round.status === 'revealed') {
    renderPlayerReveal(room, round, cr);
  } else {
    renderPlayerGuessing(room, round, cr);
  }
}

function renderPlayerGuessing(room, round, cr) {
  document.getElementById('reveal-section').classList.remove('visible');

  // Word cards (not flipped)
  const cardsEl = document.getElementById('word-cards');
  cardsEl.innerHTML = '';
  (round.words||[]).forEach(w => {
    const card = document.createElement('div');
    card.className = 'word-card';
    card.innerHTML = `<div class="word-card-inner">
      <div class="word-card-front"><div class="word-text">${w.word}</div></div>
      <div class="word-card-back"><div class="conn-word">${w.word}</div><div class="conn-explain">${w.connection}</div></div>
    </div>`;
    cardsEl.appendChild(card);
  });

  // Hints
  const playerHints = round.playerHints?.[playerId] || {};
  myHintsUsed = Object.keys(playerHints);
  renderHints(round, playerHints, cr);
  renderPointsPreview(myHintsUsed);

  // Guess / waiting
  const myGuess = round.guesses?.[playerId];
  document.getElementById('guess-form-section').style.display = myGuess ? 'none' : 'block';
  document.getElementById('guess-waiting-section').style.display = myGuess ? 'block' : 'none';
  myGuessSubmitted = !!myGuess;

  // Submitted players
  const subEl = document.getElementById('submitted-players-list');
  subEl.innerHTML = '';
  const guesses = round.guesses || {};
  Object.entries(room.players||{}).forEach(([pid, p]) => {
    const chip = document.createElement('div');
    chip.className = 'player-chip' + (guesses[pid] ? ' submitted' : '');
    chip.innerHTML = `<div class="avatar">${p.name[0].toUpperCase()}</div>${p.name}${guesses[pid]?' ‚úì':''}`;
    subEl.appendChild(chip);
  });
}

function renderPlayerReveal(room, round, cr) {
  // Flip word cards
  const cardsEl = document.getElementById('word-cards');
  cardsEl.innerHTML = '';
  (round.words||[]).forEach((w, i) => {
    const card = document.createElement('div');
    card.className = 'word-card';
    card.innerHTML = `<div class="word-card-inner">
      <div class="word-card-front"><div class="word-text">${w.word}</div></div>
      <div class="word-card-back"><div class="conn-word">${w.word}</div><div class="conn-explain">${w.connection}</div></div>
    </div>`;
    cardsEl.appendChild(card);
    setTimeout(() => card.classList.add('flipped'), 150 + i * 200);
  });

  document.getElementById('guess-form-section').style.display = 'none';
  document.getElementById('guess-waiting-section').style.display = 'none';

  const revealEl = document.getElementById('reveal-section');
  revealEl.classList.add('visible');
  document.getElementById('movie-title-reveal').textContent = round.movie;

  const gList = document.getElementById('guesses-reveal-list');
  gList.innerHTML = '';
  const guesses = round.guesses || {};
  Object.entries(guesses).forEach(([pid, g]) => {
    const li = document.createElement('li');
    li.className = 'guess-item ' + (g.correct ? 'correct' : 'wrong');
    li.innerHTML = `<div class="guess-player">${g.name||room.players?.[pid]?.name||'?'}</div>
      <div class="guess-answer">"${g.guess}"</div>
      ${g.correct ? '<span class="correct-badge">‚úì</span>' : ''}
      <div class="guess-score">${g.pts||0} pts</div>`;
    gList.appendChild(li);
  });

  document.getElementById('waiting-next-msg').style.display = 'flex';
}

// ‚îÄ‚îÄ HINTS (player) ‚îÄ‚îÄ
function renderHints(round, playerHints, cr) {
  const bar = document.getElementById('hints-bar');
  const revEl = document.getElementById('hints-revealed');
  bar.innerHTML = ''; revEl.innerHTML = '';

  const defs = [
    { key:'genre',       label:'Genre (‚àí2pts)',         val: round.genre },
    { key:'year',        label:'Year (‚àí3pts)',           val: round.year },
    { key:'firstletter', label:'First Letter (‚àí1pt)',    val: round.movie?.[0]?.toUpperCase() },
  ];
  defs.forEach(({key, label, val}) => {
    if (!val) return;
    const used = !!playerHints[key];
    const btn = document.createElement('button');
    btn.className = 'hint-btn' + (used ? ' used' : '');
    btn.textContent = used ? '‚úì ' + label.split(' ')[0] : label;
    // derive submitted state from round data, not stale module var
    const hasSubmitted = !!round.guesses?.[playerId];
    if (!used && !hasSubmitted) btn.onclick = () => requestHint(key, cr);
    else if (!used) btn.disabled = true;
    bar.appendChild(btn);
    if (used) {
      const span = document.createElement('span');
      span.className = 'hint-reveal';
      if (key==='genre') span.textContent = 'üé≠ Genre: ' + val;
      else if (key==='year') span.textContent = 'üìÖ Year: ' + val;
      else span.textContent = 'üî§ Starts with: ' + val;
      revEl.appendChild(span);
    }
  });
}

window.requestHint = async (key, cr) => {
  await update(ref(db, `rooms/${currentRoom}/rounds/${cr}/playerHints/${playerId}`), { [key]: true });
};

function renderPointsPreview(hintsUsed) {
  const el = document.getElementById('points-preview');
  el.innerHTML = '';
  const max = getMaxPoints(hintsUsed);
  [10,9,8,7,6].forEach(p => {
    const b = document.createElement('div');
    b.className = 'points-badge' + (p===max ? ' active-pts' : '');
    b.textContent = p===max ? `‚òÖ ${p} pts` : `${p} pts`;
    el.appendChild(b);
  });
}

// ‚îÄ‚îÄ SUBMIT GUESS ‚îÄ‚îÄ
window.submitGuess = async () => {
  const g = document.getElementById('guess-input').value.trim();
  if (!g) { showToast('Type your guess!'); return; }
  const cr = (await get(ref(db, 'rooms/' + currentRoom + '/currentRound'))).val();
  await update(ref(db, `rooms/${currentRoom}/rounds/${cr}/guesses/${playerId}`), {
    guess: g, name: playerName
  });
  document.getElementById('guess-input').value = '';
  myGuessSubmitted = true;
};

// ‚îÄ‚îÄ HOST GAME VIEW ‚îÄ‚îÄ
function renderHostGame(room) {
  showPage('host');
  const cr = room.currentRound;
  const round = room.rounds?.[cr];
  if (!round) return;

  document.getElementById('host-round-display').textContent = `Round ${cr}`;

  // Always show answer
  document.getElementById('host-movie-name').textContent = round.movie;
  document.getElementById('host-movie-meta').textContent =
    [round.genre, round.year].filter(Boolean).join(' ‚Ä¢ ');

  const wordGrid = document.getElementById('host-word-grid');
  wordGrid.innerHTML = '';
  (round.words||[]).forEach(w => {
    const pill = document.createElement('div');
    pill.className = 'host-word-pill';
    pill.innerHTML = `<strong>${w.word}</strong>${w.connection}`;
    wordGrid.appendChild(pill);
  });

  // Live submissions
  const subEl = document.getElementById('host-submitted-list');
  subEl.innerHTML = '';
  const guesses = round.guesses || {};
  Object.entries(room.players||{}).forEach(([pid, p]) => {
    const chip = document.createElement('div');
    chip.className = 'player-chip' + (guesses[pid] ? ' submitted' : '');
    chip.innerHTML = `<div class="avatar">${p.name[0].toUpperCase()}</div>${p.name}${guesses[pid]?' ‚úì':''}`;
    subEl.appendChild(chip);
  });

  const totalPlayers = Object.keys(room.players||{}).length;
  const submittedCount = Object.keys(guesses).length;
  const waitEl = document.getElementById('host-waiting-status');
  waitEl.innerHTML = submittedCount >= totalPlayers
    ? '‚úÖ All guesses in!'
    : `${submittedCount} / ${totalPlayers} submitted<span class="waiting-dots"></span>`;

  // Live scores
  renderHostScores(room);

  if (round.status === 'revealed') {
    renderHostReveal(room, round, cr);
  } else {
    document.getElementById('host-reveal-section').classList.remove('visible');
    // Auto-reveal when all in
    if (submittedCount >= totalPlayers && totalPlayers > 0) {
      autoReveal(round, cr, room);
    }
  }
}

function renderHostScores(room) {
  const el = document.getElementById('host-live-scores');
  el.innerHTML = '';
  const sorted = Object.entries(room.players||{}).sort((a,b)=>b[1].score-a[1].score);
  sorted.forEach(([pid,p],i) => {
    const li = document.createElement('li');
    li.className = 'score-row';
    li.style.animationDelay = (i*0.05)+'s';
    li.innerHTML = `<div class="score-rank">${i+1}</div>
      <div class="score-name">${p.name}</div>
      <div class="score-pts">${p.score} pts</div>`;
    el.appendChild(li);
  });
}

function renderHostReveal(room, round, cr) {
  const el = document.getElementById('host-reveal-section');
  el.classList.add('visible');

  const gl = document.getElementById('host-guesses-list');
  gl.innerHTML = '';
  const guesses = round.guesses || {};
  Object.entries(guesses).forEach(([pid,g]) => {
    const li = document.createElement('li');
    li.className = 'guess-item ' + (g.correct ? 'correct' : 'wrong');
    li.innerHTML = `<div class="guess-player">${g.name||room.players?.[pid]?.name||'?'}</div>
      <div class="guess-answer">"${g.guess}"</div>
      ${g.correct?'<span class="correct-badge">‚úì Correct</span>':''}
      <div class="guess-score">${g.pts||0} pts</div>`;
    gl.appendChild(li);
  });

  // Check if more movies available
  const snap_check = get(ref(db, 'movies')).then(snap => {
    const all = snap.exists() ? Object.keys(snap.val()) : [];
    const used = room.usedMovies ? Object.keys(room.usedMovies) : [];
    const remaining = all.filter(id => !used.includes(id));
    document.getElementById('host-next-btn').textContent =
      remaining.length > 0 ? 'Next Round ‚Üí' : 'No More Movies ‚Äî End Game üèÅ';
    document.getElementById('host-next-btn').onclick =
      remaining.length > 0 ? nextRound : confirmEndGame;
  });
}

// ‚îÄ‚îÄ AUTO REVEAL ‚îÄ‚îÄ
async function autoReveal(round, cr, room) {
  const guesses = round.guesses || {};
  const movieTitle = round.movie.toLowerCase().trim();
  const updates = {};

  Object.entries(guesses).forEach(([pid, g]) => {
    const hintsUsed = Object.keys(round.playerHints?.[pid] || {});
    const maxPts = getMaxPoints(hintsUsed);
    const correct = isCloseEnough(g.guess, movieTitle);
    const pts = correct ? maxPts : 0;
    updates[`rooms/${currentRoom}/rounds/${cr}/guesses/${pid}/correct`] = correct;
    updates[`rooms/${currentRoom}/rounds/${cr}/guesses/${pid}/pts`] = pts;
    updates[`rooms/${currentRoom}/players/${pid}/score`] = (room.players[pid]?.score||0) + pts;
  });
  updates[`rooms/${currentRoom}/rounds/${cr}/status`] = 'revealed';
  await update(ref(db), updates);
}

// ‚îÄ‚îÄ NEXT ROUND ‚îÄ‚îÄ
window.nextRound = async () => {
  const snap = await get(ref(db, 'rooms/' + currentRoom));
  const room = snap.val();
  const next = room.currentRound + 1;
  const movie = await pickNextMovie(room.usedMovies||{});

  if (!movie) {
    // No more movies ‚Äî end game
    await update(ref(db, 'rooms/' + currentRoom), { status: 'gameover' });
    return;
  }

  myGuessSubmitted = false;
  myHintsUsed = [];

  const updates = {};
  updates[`rooms/${currentRoom}/currentRound`] = next;
  updates[`rooms/${currentRoom}/rounds/${next}`] = {
    movieId: movie.id, movie: movie.title, words: movie.words,
    genre: movie.genre||'', year: movie.year||'', status: 'guessing'
  };
  updates[`rooms/${currentRoom}/usedMovies/${movie.id}`] = true;
  await update(ref(db), updates);
};

// ‚îÄ‚îÄ END GAME ‚îÄ‚îÄ
window.endGame = () => document.getElementById('end-modal').classList.add('open');
window.closeEndModal = () => document.getElementById('end-modal').classList.remove('open');
window.confirmEndGame = async () => {
  closeEndModal();
  await update(ref(db, 'rooms/' + currentRoom), { status: 'gameover' });
};

// ‚îÄ‚îÄ GAME OVER ‚îÄ‚îÄ
function renderGameOver(room) {
  showPage('scoreboard');
  const players = Object.entries(room.players||{}).sort((a,b)=>b[1].score-a[1].score);
  const list = document.getElementById('final-scoreboard');
  list.innerHTML = '';
  players.forEach(([pid,p],i) => {
    const li = document.createElement('li');
    li.className = 'score-row';
    li.style.animationDelay = (i*0.1)+'s';
    li.innerHTML = `<div class="score-rank">${i+1}</div>
      <div class="score-name">${p.name}${pid===playerId?' (you)':''}</div>
      <div class="score-pts">${p.score} pts</div>`;
    list.appendChild(li);
  });

  const winner = players[0]?.[1];
  const winnerEl = document.getElementById('winner-display');
  if (winner) {
    winnerEl.innerHTML = `<div class="confetti-burst">üéä</div>
      <div class="winner-name">${winner.name} wins!</div>
      <div style="text-align:center;color:var(--text-muted);margin-top:6px;">${winner.score} points ‚Ä¢ ${room.currentRound} rounds played</div>`;
  } else {
    winnerEl.innerHTML = `<div class="confetti-burst">üé¨</div><div class="winner-name">Game Over!</div>`;
  }
}

// ‚îÄ‚îÄ LEAVE ‚îÄ‚îÄ
window.leaveRoom = async () => {
  if (currentRoom && playerId && !isHost) {
    await remove(ref(db, `rooms/${currentRoom}/players/${playerId}`));
  }
  stopListener();
  currentRoom = null; isHost = false;
  showPage('home');
};

// ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ
window.goToAdmin = () => { showPage('admin'); clearMovieForm(); loadMovieLibrary(); };
window.switchAdminTab = (tab) => {
  document.getElementById('admin-tab-add').style.display = tab==='add'?'block':'none';
  document.getElementById('admin-tab-list').style.display = tab==='list'?'block':'none';
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (tab==='add'&&i===0)||(tab==='list'&&i===1)));
  if (tab==='list') loadMovieLibrary();
};

window.addWordRow = () => {
  const container = document.getElementById('admin-words-container');
  const existing = container.querySelectorAll('.admin-word-row').length;
  if (existing >= 5) { showToast('Max 5 words!'); return; }
  const idx = wordRowCount++;
  const row = document.createElement('div');
  row.className = 'admin-word-row admin-movie-card';
  row.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <strong style="color:var(--pink-deep);font-size:.9rem;">Word ${existing+1}</strong>
      <button class="remove-btn" onclick="removeWordRow(this)">‚úï</button>
    </div>
    <div class="word-row">
      <div class="input-group" style="margin:0;">
        <label>Clue Word</label>
        <input type="text" class="aw-word" placeholder="e.g. Green">
      </div>
      <div class="input-group" style="margin:0;">
        <label>What it connects to</label>
        <input type="text" class="aw-connection" placeholder="e.g. Mantis's skin color">
      </div>
    </div>`;
  container.appendChild(row);
  if (container.querySelectorAll('.admin-word-row').length >= 5)
    document.getElementById('add-word-btn').disabled = true;
};

window.removeWordRow = (btn) => {
  btn.closest('.admin-word-row').remove();
  document.getElementById('add-word-btn').disabled = false;
  document.querySelectorAll('.admin-word-row').forEach((r,i) => {
    r.querySelector('strong').textContent = 'Word '+(i+1);
  });
};

window.clearMovieForm = () => {
  document.getElementById('admin-movie-title').value = '';
  document.getElementById('admin-movie-genre').value = '';
  document.getElementById('admin-movie-year').value = '';
  document.getElementById('admin-words-container').innerHTML = '';
  document.getElementById('add-word-btn').disabled = false;
  wordRowCount = 0;
  addWordRow(); addWordRow(); addWordRow();
};

window.saveMovie = async () => {
  const title = document.getElementById('admin-movie-title').value.trim();
  const genre = document.getElementById('admin-movie-genre').value.trim();
  const year = document.getElementById('admin-movie-year').value.trim();
  if (!title) { showToast('Enter a movie title!'); return; }
  const rows = document.querySelectorAll('.admin-word-row');
  const words = []; let valid = true;
  rows.forEach(row => {
    const w = row.querySelector('.aw-word').value.trim();
    const c = row.querySelector('.aw-connection').value.trim();
    if (!w||!c) { valid=false; return; }
    words.push({ word:w, connection:c });
  });
  if (!valid || words.length < 3) { showToast('Fill in all words & connections (min 3)!'); return; }
  await push(ref(db, 'movies'), { title, genre, year, words, createdAt: Date.now() });
  showToast('‚úÖ Saved: ' + title);
  clearMovieForm();
  switchAdminTab('list');
};

window.loadMovieLibrary = async () => {
  const list = document.getElementById('saved-movies-list');
  list.innerHTML = '<li style="color:var(--text-muted);font-size:14px;">Loading‚Ä¶</li>';
  const snap = await get(ref(db, 'movies'));
  list.innerHTML = '';
  if (!snap.exists()) {
    list.innerHTML = '<li style="color:var(--text-muted);font-size:14px;">No movies yet. Add some!</li>';
    return;
  }
  Object.entries(snap.val()).forEach(([id, movie]) => {
    const li = document.createElement('li');
    li.className = 'saved-movie-item';
    const tags = (movie.words||[]).map(w=>`<span class="word-tag">${w.word}</span>`).join('');
    li.innerHTML = `
      <div>
        <div class="saved-movie-title">${movie.title}</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">${movie.genre||''} ${movie.year?'‚Ä¢ '+movie.year:''}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;">${tags}</div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="openDeleteModal('${id}')">Delete</button>`;
    list.appendChild(li);
  });
};

window.openDeleteModal = (id) => { deleteTargetId=id; document.getElementById('delete-modal').classList.add('open'); };
window.closeDeleteModal = () => { deleteTargetId=null; document.getElementById('delete-modal').classList.remove('open'); };
window.confirmDelete = async () => {
  if (deleteTargetId) {
    await remove(ref(db,'movies/'+deleteTargetId));
    showToast('Deleted!');
    closeDeleteModal(); loadMovieLibrary();
  }
};

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
clearMovieForm();
checkURLParams();
</script>
</body>
</html>
